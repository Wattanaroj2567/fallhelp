// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  firstName    String
  lastName     String
  gender       Gender? // Added Gender field
  phone        String?
  profileImage String?
  pushToken    String? // Expo Push Token for push notifications
  role         UserRole @default(CAREGIVER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  elders        UserElderAccess[]
  notifications Notification[]
  authOtps      AuthOtp[]
  feedbacks     Feedback[]

  @@map("users")
}

enum UserRole {
  ADMIN
  CAREGIVER
}

model AuthOtp {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String
  purpose   OtpPurpose
  expiresAt DateTime
  isUsed    Boolean    @default(false)
  createdAt DateTime   @default(now())

  @@index([userId, purpose, expiresAt])
  @@map("auth_otps")
}

enum OtpPurpose {
  PASSWORD_RESET
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
}

// ==================== ELDER & DEVICE ====================

model Elder {
  id           String    @id @default(uuid())
  firstName    String
  lastName     String
  gender       Gender?
  dateOfBirth  DateTime?
  height       Float? // ส่วนสูง (cm)
  weight       Float? // น้ำหนัก (kg)
  diseases     String[] // โรคประจำตัว
  
  // ที่อยู่แบบแยกฟิลด์
  houseNumber  String?  // บ้านเลขที่
  village      String?  // หมู่บ้าน/อาคาร
  subdistrict  String?  // ตำบล/แขวง
  district     String?  // อำเภอ/เขต
  province     String?  // จังหวัด
  zipcode      String?  // รหัสไปรษณีย์
  
  profileImage String?
  bloodType    String?
  allergies    String[]
  medications  String[]
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  device            Device?
  caregivers        UserElderAccess[]
  emergencyContacts EmergencyContact[]
  events            Event[]

  @@map("elders")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Device {
  id              String       @id @default(uuid())
  deviceCode      String       @unique // รหัสอุปกรณ์สำหรับ QR Code
  serialNumber    String       @unique
  elderId         String?      @unique
  elder           Elder?       @relation(fields: [elderId], references: [id], onDelete: SetNull)
  status          DeviceStatus @default(INACTIVE)
  lastOnline      DateTime?
  firmwareVersion String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  config DeviceConfig?
  events Event[]

  @@map("devices")
}

enum DeviceStatus {
  ACTIVE // เชื่อมต่อแล้ว
  INACTIVE // ไม่ได้เชื่อมต่อ
  MAINTENANCE // อยู่ระหว่างซ่อม
  PAIRED // ผูกกับผู้สูงอายุแล้ว
  UNPAIRED // ยังไม่ได้ผูก
}

model DeviceConfig {
  id       String @id @default(uuid())
  deviceId String @unique
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Wi-Fi Settings
  ssid         String?
  wifiPassword String? // เข้ารหัสก่อนเก็บ
  wifiStatus   WifiStatus @default(DISCONNECTED)
  ipAddress    String?

  // Sensor Settings
  fallThreshold   Float @default(2.5) // g-force threshold
  hrLowThreshold  Int   @default(50) // BPM
  hrHighThreshold Int   @default(120) // BPM

  // Notification Settings
  fallCancelTime Int @default(30) // วินาที (ตาม UI)

  updatedAt DateTime @updatedAt

  @@map("device_configs")
}

enum WifiStatus {
  CONNECTED
  DISCONNECTED
  CONFIGURING
  ERROR
}

// ==================== EMERGENCY CONTACTS ====================

model EmergencyContact {
  id           String   @id @default(uuid())
  elderId      String
  elder        Elder    @relation(fields: [elderId], references: [id], onDelete: Cascade)
  name         String
  phone        String
  relationship String? // เช่น "ลูก", "หลาน", "เพื่อนบ้าน"
  priority     Int // 1 = สำคัญที่สุด, 2 = รอง, ...
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([elderId, priority]) // ห้ามมี priority ซ้ำในคนเดียวกัน
  @@index([elderId, priority])
  @@map("emergency_contacts")
}

// ==================== EVENTS (TimescaleDB) ====================

model Event {
  id       String @default(uuid())
  elderId  String
  elder    Elder  @relation(fields: [elderId], references: [id], onDelete: Cascade)
  deviceId String
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  type     EventType
  severity EventSeverity @default(NORMAL)
  value    Float? // ค่า BPM (null ถ้าเป็น FALL)

  // Fall Detection Specific (ตาม UI - มีปุ่มยกเลิกภายใน 30 วินาที)
  isCancelled Boolean   @default(false)
  cancelledAt DateTime?

  // Notification
  isNotified Boolean   @default(false)
  notifiedAt DateTime?

  // Sensor Data (optional - เก็บข้อมูลดิบสำหรับวิเคราะห์)
  accelerometerX Float?
  accelerometerY Float?
  accelerometerZ Float?
  gyroscopeX     Float?
  gyroscopeY     Float?
  gyroscopeZ     Float?

  metadata Json? // เก็บข้อมูลเพิ่มเติมแบบ flexible

  timestamp DateTime @default(now())

  // Relations
  notifications Notification[]

  // TimescaleDB: Composite primary key with timestamp for partitioning
  @@id([id, timestamp])
  @@index([elderId, timestamp(sort: Desc)])
  @@index([deviceId, timestamp(sort: Desc)])
  @@index([type, timestamp(sort: Desc)])
  @@map("events")
}

enum EventType {
  FALL
  HEART_RATE_HIGH
  HEART_RATE_LOW
  HEART_RATE_NORMAL
  DEVICE_OFFLINE
  DEVICE_ONLINE
  SENSOR_ERROR
}

enum EventSeverity {
  CRITICAL // ฉุกเฉิน (หกล้ม, HR สูง/ต่ำมาก)
  WARNING // เตือน (HR เริ่มผิดปกติ)
  NORMAL // ปกติ (HR ปกติ, เชื่อมต่อสำเร็จ)
  INFO // ข้อมูลทั่วไป
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId        String?
  eventTimestamp DateTime?
  event          Event?    @relation(fields: [eventId, eventTimestamp], references: [id, timestamp], onDelete: SetNull)

  type    NotificationType
  title   String
  message String
  isRead  Boolean          @default(false)
  readAt  DateTime?

  // Push Notification Tracking
  pushToken String?
  isSent    Boolean   @default(false)
  sentAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

enum NotificationType {
  FALL_DETECTED // ตรวจพบการหกล้ม
  HEART_RATE_ALERT // ชีพจรสูง/ต่ำกว่าปกติ
  DEVICE_OFFLINE // อุปกรณ์ขาดการเชื่อมต่อ
  DEVICE_ONLINE // อุปกรณ์เชื่อมต่อแล้ว
  SYSTEM_UPDATE // แจ้งอัปเดตระบบ
  EMERGENCY_CONTACT_CALLED // มีการโทรฉุกเฉิน
}

// ==================== MANY-TO-MANY RELATIONS ====================

model UserElderAccess {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  elderId     String
  elder       Elder       @relation(fields: [elderId], references: [id], onDelete: Cascade)
  accessLevel AccessLevel @default(VIEWER)
  grantedAt   DateTime    @default(now())

  @@unique([userId, elderId])
  @@index([userId])
  @@index([elderId])
  @@map("user_elder_access")
}

enum AccessLevel {
  OWNER // เจ้าของหลัก - สามารถลบ/โอนได้
  ADMIN // แก้ไขได้ทั้งหมด
  EDITOR // แก้ไขข้อมูลได้ แต่ลบไม่ได้
  VIEWER // ดูได้อย่างเดียว
}

// ==================== FEEDBACK ====================

model Feedback {
  id        String         @id @default(uuid())
  userId    String? // Optional: User might send anonymously or if we want to track
  user      User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  message   String
  userName  String? // Display name from mobile app (English)
  status    FeedbackStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("feedbacks")
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  RESOLVED
}
