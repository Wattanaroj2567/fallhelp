# Device Pairing & WiFi Configuration

# à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸ˆà¸±à¸šà¸„à¸¹à¹ˆà¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² WiFi

à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸™à¸µà¹‰à¸­à¸˜à¸´à¸šà¸²à¸¢ Flow à¸à¸²à¸£à¸ˆà¸±à¸šà¸„à¸¹à¹ˆà¸­à¸¸à¸›à¸à¸£à¸“à¹Œ ESP32 à¸à¸±à¸šà¹à¸­à¸› (à¸­à¸±à¸›à¹€à¸”à¸•: à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡ 2025)

---

## Overview

à¸à¸²à¸£à¸ˆà¸±à¸šà¸„à¸¹à¹ˆà¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸¡à¸µ 2 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸«à¸¥à¸±à¸:

1. **Device Pairing** - à¸œà¸¹à¸à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸à¸±à¸šà¸œà¸¹à¹‰à¸ªà¸¹à¸‡à¸­à¸²à¸¢à¸¸
2. **WiFi Configuration** - à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² WiFi à¹ƒà¸«à¹‰à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ (à¸œà¹ˆà¸²à¸™ Captive Portal)

---

## Phase 1: Device Pairing (à¸œà¸¹à¸à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ)

### Flow Diagram

```
Admin à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ â†’ QR Code à¸šà¸™à¸à¸¥à¹ˆà¸­à¸‡ â†’ à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹à¸à¸™ â†’ à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸–à¸¹à¸à¸œà¸¹à¸
```

### à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

| Step | Action                      | API                         |
| :--: | --------------------------- | --------------------------- |
|  1   | Admin à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹ƒà¸™à¸£à¸°à¸šà¸š    | `POST /admin/devices`       |
|  2   | à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸ªà¸¹à¸‡à¸­à¸²à¸¢à¸¸ | `POST /elders`              |
|  3   | à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¹à¸à¸™ QR Code à¸ˆà¸²à¸à¸à¸¥à¹ˆà¸­à¸‡ | -                           |
|  4   | à¹à¸­à¸›à¹€à¸£à¸µà¸¢à¸ API à¸œà¸¹à¸à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ     | `POST /devices/{code}/pair` |

### QR Code Format

```json
{
  "deviceCode": "FH-DEV-001",
  "serialNumber": "ESP32-XXXXXXXXXXXX"
}
```

---

## Phase 2: WiFi Configuration (à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² WiFi)

### âœ¨ à¸§à¸´à¸˜à¸µà¹ƒà¸«à¸¡à¹ˆ: Captive Portal (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™)

```
à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡ WiFi à¸‚à¸­à¸‡ ESP32 â†’ Captive Portal à¹€à¸›à¸´à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ â†’ à¸à¸£à¸­à¸ WiFi â†’ à¸—à¸”à¸ªà¸­à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ â†’ à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
```

### à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

| Step | Action                            | à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”                              |
| :--: | --------------------------------- | --------------------------------------- |
|  1   | ESP32 à¹€à¸›à¸´à¸” Access Point (Open)    | SSID: `FallHelp-XXXXXX` (à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™) |
|  2   | à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WiFi à¸‚à¸­à¸‡ ESP32    | Captive Portal à¸ˆà¸°à¹€à¸›à¸´à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´          |
|  3   | à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­ WiFi + à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™    | Validation: à¸£à¸«à¸±à¸ª 8 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸‚à¸¶à¹‰à¸™à¹„à¸›       |
|  4   | ESP32 à¸—à¸”à¸ªà¸­à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ˆà¸£à¸´à¸‡          | à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸² ~10 à¸§à¸´à¸™à¸²à¸—à¸µ                      |
|  5   | à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ à¸ªà¸³à¹€à¸£à¹‡à¸ˆ/à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§        | à¸«à¸™à¹‰à¸² HTML à¹ƒà¸«à¸¡à¹ˆ                          |
|  6   | ESP32 à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸—à¹à¸¥à¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡ WiFi à¸šà¹‰à¸²à¸™ | à¸ªà¹ˆà¸‡ status à¹„à¸› Backend                   |

### ESP32 Access Point

```
SSID: FallHelp-XXXXXX (6 à¸«à¸¥à¸±à¸à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸‚à¸­à¸‡ Serial)
Password: à¹„à¸¡à¹ˆà¸¡à¸µ (Open Network)
Captive Portal: à¹€à¸›à¸´à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
```

### Config Endpoint (ESP32)

```
POST http://192.168.4.1/wifi-config

Content-Type: application/x-www-form-urlencoded
ssid=Home_WiFi&password=wifi_password
```

### à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š

- ESP32 à¸ˆà¸°à¸—à¸”à¸ªà¸­à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WiFi à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¸šà¸±à¸™à¸—à¸¶à¸
- **à¸ªà¸³à¹€à¸£à¹‡à¸ˆ:** à¸šà¸±à¸™à¸—à¸¶à¸ config â†’ à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ â†’ à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸—
- **à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:** à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” â†’ à¸à¸¥à¸±à¸š AP Mode â†’ à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰

---

## Device Status Flow

```
UNPAIRED â†’ INACTIVE â†’ ACTIVE
```

| Status   | Description               |
| -------- | ------------------------- |
| UNPAIRED | à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸œà¸¹à¸à¸à¸±à¸šà¸œà¸¹à¹‰à¸ªà¸¹à¸‡à¸­à¸²à¸¢à¸¸ |
| INACTIVE | à¸œà¸¹à¸à¹à¸¥à¹‰à¸§ à¹à¸•à¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ  |
| ACTIVE   | à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹à¸¥à¸°à¸—à¸³à¸‡à¸²à¸™à¸›à¸à¸•à¸´     |

### Offline Detection (MQTT Last Will)

- ESP32 à¸•à¸±à¹‰à¸‡ Last Will Testament à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MQTT
- à¸–à¹‰à¸² ESP32 disconnect à¹‚à¸”à¸¢à¹„à¸¡à¹ˆ graceful â†’ MQTT broker à¸ªà¹ˆà¸‡ offline message
- Backend à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹€à¸›à¹‡à¸™ INACTIVE à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´

---

## Mobile App Implementation

### Step 3 WiFi Setup Screen

```typescript
// à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹à¸ªà¸”à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WiFi à¸‚à¸­à¸‡ ESP32
// Captive Portal à¸ˆà¸°à¹€à¸›à¸´à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸šà¸™à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ

const handleComplete = () => {
  // à¹€à¸¡à¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§
  router.replace("/(tabs)");
};
```

### Device Details - Last Seen

```typescript
// à¹à¸ªà¸”à¸‡ "à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œà¸¥à¹ˆà¸²à¸ªà¸¸à¸”" à¹€à¸¡à¸·à¹ˆà¸­à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ Offline
const formatLastSeen = (date) => {
  const diffMins = Math.floor((Date.now() - date) / 60000);
  if (diffMins < 60) return `${diffMins} à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§`;
  // ...
};
```

---

## Troubleshooting

| à¸›à¸±à¸à¸«à¸²                    | à¸§à¸´à¸˜à¸µà¹à¸à¹‰à¹„à¸‚                           |
| ------------------------ | ----------------------------------- |
| à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™ WiFi à¸‚à¸­à¸‡ ESP32   | à¸£à¸­ 30 à¸§à¸´à¸™à¸²à¸—à¸µà¸«à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ         |
| Captive Portal à¹„à¸¡à¹ˆà¹€à¸›à¸´à¸”   | à¹€à¸›à¸´à¸” Browser à¹à¸¥à¹‰à¸§à¹„à¸› 192.168.4.1     |
| à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WiFi à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ | à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸«à¸±à¸ª WiFi (8 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¸‚à¸¶à¹‰à¸™à¹„à¸›) |
| à¸ªà¸–à¸²à¸™à¸°à¸¢à¸±à¸‡à¹€à¸›à¹‡à¸™ Offline     | à¸£à¸­ 30 à¸§à¸´à¸™à¸²à¸—à¸µ à¸«à¸£à¸·à¸­ refresh à¸«à¸™à¹‰à¸²      |
| à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ Offline à¸­à¸¢à¸¹à¹ˆà¸•à¸¥à¸­à¸” | à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š MQTT Server à¸—à¸³à¸‡à¸²à¸™           |

---

## Notification Messages

| Event          | Title                      | Message                                      |
| -------------- | -------------------------- | -------------------------------------------- |
| Device Offline | ðŸ“± à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸«à¸¥à¸¸à¸”à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ | à¸­à¸²à¸ˆà¹€à¸à¸´à¸”à¸ˆà¸²à¸: WiFi à¸«à¸¥à¸¸à¸”, à¹à¸šà¸•à¸«à¸¡à¸” à¸«à¸£à¸·à¸­à¸›à¸´à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ |
| Device Online  | âœ… à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸à¸¥à¸±à¸šà¸¡à¸²à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ    | à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸‚à¸­à¸‡ {elderName} à¸à¸¥à¸±à¸šà¸¡à¸²à¸—à¸³à¸‡à¸²à¸™à¸›à¸à¸•à¸´       |

---

**Last Updated:** December 14, 2025  
**Status:** Production Ready with Captive Portal
